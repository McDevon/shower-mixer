(window["webpackJsonpshower-mixer"]=window["webpackJsonpshower-mixer"]||[]).push([[0],{21:function(t,e,i){t.exports=i(32)},26:function(t,e,i){},32:function(t,e,i){"use strict";i.r(e);var n=i(0),r=i.n(n),a=i(10),s=i.n(a),o=(i(26),function(){return r.a.createElement("div",{style:{textAlign:"right"}},r.a.createElement("p",null,"Copyright (c) Jussi Enroos 2019",r.a.createElement("br",null),r.a.createElement("a",{href:"https://github.com/McDevon/shower-mixer"},"Source")," with MIT license"))}),h=i(11),l=i(19),c=function(t,e){if(void 0!==typeof t.getContext){!function(){for(var t=["webkit","moz"],e=0;e<t.length&&!window.requestAnimationFrame;++e)window.requestAnimationFrame=window[t[e]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[t[e]+"CancelAnimationFrame"]||window[t[e]+"CancelRequestAnimationFrame"]}();var i=t.getContext("2d"),n=(new Date).getTime(),r=0,a=0,s=0,o=0;t.simulation=e,e.init(t);!function t(){for(window.requestAnimationFrame(t),r=(new Date).getTime(),a=Math.min((r-n)/1e3,.03),o=0,(s+=a)<1/60&&(s=1/60);s>=1/60&&o<1;)e.fixedUpdate(1/60),s-=1/60,o++;o>=1&&(s=0),e.update(a),e.render(i),n=r}()}},u=i(2),m=i(3),p=function(){function t(e){Object(u.a)(this,t),this.size=e,this.buffer=[],this.buffer.length=e,this.nextIndex=0}return Object(m.a)(t,[{key:"put",value:function(t){this.buffer[this.nextIndex]=t,this.nextIndex=(this.nextIndex+1)%this.size}},{key:"getHead",value:function(){return this.buffer[(this.nextIndex-1)%this.size]}},{key:"getTail",value:function(){return this.buffer[this.nextIndex]}},{key:"getAll",value:function(){for(var t=this.nextIndex,e=[],i=0;i<this.size;i++)e.push(this.buffer[t]),t=(t+1)%this.size;return e}}]),t}(),d=function(){function t(e,i,n,r,a,s){Object(u.a)(this,t),this.margin=5,this.width=r.width-2*this.margin,this.height=r.height-2*this.margin,this.maxVals=e,this.top=i,this.bottom=n,this.targetTop=a,this.targetBottom=s,this.stepLength=(this.width-2*this.margin)/e,this.verticalStep=(this.height-2*this.margin)/(i-n),this.cx=r.getContext("2d")}return Object(m.a)(t,[{key:"drawChartLine",value:function(t,e,i,n,r,a){this.cx.stroke(),1!==a&&(this.cx.fillStyle=0===a?"#BBBBFF55":"#FFBBBB55",this.cx.lineTo(e,t<this.targetBottom?r:n),this.cx.lineTo(i,t<this.targetBottom?r:n),this.cx.fill())}},{key:"draw",value:function(t){var e=this.pixel(this.margin),i=this.pixel(this.margin),n=this.pixel(e+this.width-2*this.margin),r=this.pixel(i+this.height-2*this.margin),a=i+this.height-this.verticalStep*(this.targetTop-this.bottom),s=i+this.height-this.verticalStep*(this.targetBottom-this.bottom);this.cx.strokeStyle="#002200",this.cx.lineWidth=2;var o=e,h=i+this.height-this.verticalStep*(t[0]-this.bottom),l=1;this.cx.beginPath(),this.cx.moveTo(o,h);for(var c=e,u=t[0],m=0,p=t.length;m<p;m++){var d=t[m],g=d<this.targetBottom?0:d>this.targetTop?2:1,x=e+this.stepLength*m,f=i+this.height-this.verticalStep*(d-this.bottom);g!==l&&(this.drawChartLine(u,o,c,a,s,l),this.cx.beginPath(),this.cx.moveTo(o,h),l=g,c=o,u=d),this.cx.lineTo(x,f),o=x,h=f}this.drawChartLine(u,o,c,a,s,l),this.cx.strokeStyle="#000000",this.cx.fillStyle="#000000",this.cx.lineWidth=1,this.cx.beginPath(),this.cx.moveTo(e,i),this.cx.lineTo(e,r),this.cx.stroke(),this.cx.beginPath(),this.cx.moveTo(e,i),this.cx.lineTo(e-2,i+10),this.cx.lineTo(e+2,i+10),this.cx.fill(),this.cx.beginPath(),this.cx.moveTo(e,r),this.cx.lineTo(n,r),this.cx.stroke(),this.cx.beginPath(),this.cx.moveTo(n,r),this.cx.lineTo(n-10,r-2),this.cx.lineTo(n-10,r+2),this.cx.fill(),this.cx.strokeStyle="#77AA77",this.cx.beginPath(),this.cx.moveTo(e,this.pixel(i+this.height-this.verticalStep*(this.targetTop-this.bottom))),this.cx.lineTo(n,this.pixel(i+this.height-this.verticalStep*(this.targetTop-this.bottom))),this.cx.moveTo(e,this.pixel(i+this.height-this.verticalStep*(this.targetBottom-this.bottom))),this.cx.lineTo(n,this.pixel(i+this.height-this.verticalStep*(this.targetBottom-this.bottom))),this.cx.stroke()}},{key:"pixel",value:function(t){return Math.round(t)+.5}}]),t}(),g=function(){function t(e,i,n,r,a){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];Object(u.a)(this,t),this.e=0,this.lastE=0,this.p=e,this.i=i,this.d=n,this.minU=r,this.maxU=a,this.iTerm=0,this.antiWindup=s}return Object(m.a)(t,[{key:"step",value:function(t,e){var i=e-t,n=this.iTerm+i,r=i-this.lastE,a=this.p*i+this.i*n+this.d*r,s=!1;return a>this.maxU?(a=this.maxU,this.antiWindup&&i>0&&(s=!0)):a<this.minU&&(a=this.minU,this.antiWindup&&i<0&&(s=!0)),s||(this.iTerm=n),this.lastE=i,a}}]),t}(),x=function(){function t(){Object(u.a)(this,t)}return Object(m.a)(t,[{key:"init",value:function(t){this.canvas=t,this.width=t.width,this.height=t.height;this.delayQueue=new p(180),this.running=!0,this.targetTemperature=36,this.minTemperature=15,this.maxTemperature=55,this.maxChangeSpeed=4,this.completionTime=4,this.completeTimer=0,this.maxDeltaSpeed=.02,this.lastDiff=0,this.running=!1,this.usePid=!1,this.reset()}},{key:"reset",value:function(t){this.controlMinTemperature=this.minTemperature+12*Math.random(),this.controlMaxTemperature=this.maxTemperature-10*Math.random(),this.currentTemperature=this.controlMinTemperature+3*Math.random(),this.mixerTemperature=this.currentTemperature,this.completionCallback=t;for(var e=0;e<this.delayQueue.size;e++)this.delayQueue.put(this.currentTemperature);return this.graphList=new p(1800),this.plotter=new d(1800,this.maxTemperature,this.minTemperature,this.canvas,this.targetTemperature+.5,this.targetTemperature-.5),this.pid=new g(.001,15e-5,0,0,1,!0),this.tempToMixer(this.mixerTemperature)}},{key:"setRunning",value:function(t){this.running=t}},{key:"setPid",value:function(t){this.usePid=t}},{key:"tempToMixer",value:function(t){return 1-(t-this.controlMinTemperature)/(this.controlMaxTemperature-this.controlMinTemperature)}},{key:"mixerToTemp",value:function(t){return this.controlMinTemperature+(this.controlMaxTemperature-this.controlMinTemperature)*(1-t)}},{key:"completed",value:function(){console.log("COMPLETED!"),this.completionCallback(this.tempToMixer(this.mixerTemperature))}},{key:"setMixer",value:function(t){this.mixerTemperature=this.mixerToTemp(t),console.log("Target ".concat(this.mixerTemperature))}},{key:"fixedUpdate",value:function(t){if(this.running){if(this.usePid){var e=1-this.pid.step(this.delayQueue.getTail()||this.currentTemperature,this.targetTemperature);this.mixerTemperature=this.mixerToTemp(e)}var i=this.mixerTemperature-this.currentTemperature,n=i,r=this.maxChangeSpeed/(this.maxDeltaSpeed*t);if(Math.abs(i)<r){var a=Math.abs(i)*this.maxDeltaSpeed;n=Math.sign(i)*a}Math.abs(n)>this.maxChangeSpeed*t&&(n=this.maxChangeSpeed*Math.sign(n)*t),Math.abs(n)>Math.abs(this.lastDiff)&&Math.abs(this.lastDiff-n)>this.maxDeltaSpeed*t&&(n=this.lastDiff+this.maxDeltaSpeed*t*Math.sign(n)),this.lastDiff=n,this.currentTemperature+=n;var s=this.delayQueue.getTail();this.delayQueue.put(this.currentTemperature),this.graphList.put(s),s<this.targetTemperature+.5&&s>this.targetTemperature-.5?(this.completeTimer+=t,this.completeTimer>=this.completionTime&&this.completed()):this.completeTimer=0}}},{key:"update",value:function(t){}},{key:"render",value:function(t){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.plotter.draw(this.graphList.getAll().filter(function(t){return null!=t}))}}]),t}(),f=function(){return new x},v=i(18),T=function(t){var e=t.value,i=t.step,n=t.min,a=t.max,s=t.onChange;t.suffix;return console.log("Mixer value ".concat(e)),r.a.createElement("div",{style:{marginTop:"5px",marginLeft:"5px",marginRight:"5px",marginBottom:"5px"}},r.a.createElement(v.a,{axis:"y",ystep:i,ymin:n,ymax:a,y:e,onChange:s(),styles:{track:{backgroundColor:"red",height:300},active:{backgroundColor:"blue"}}}))},b=i(14),w=i(15);function y(){var t=Object(b.a)(["\n    background-color: ",";\n    border: none;\n    border-radius: 4px;\n    color: white;\n    padding: 10px 20px;\n    text-align: center;\n    text-decoration: none;\n    display: inline-block;\n    margin: 0px;\n    font-size: 16px;\n    opacity: ",";\n    :hover {\n        background-color: ",";\n    }\n    :focus {\n        outline: none;\n    }\n    :active {\n        padding: 9px 18px;\n        font-size: 14px;\n        margin: 1px 4px;\n    }\n    "]);return y=function(){return t},t}var k=function(t){var e=t.onClick,i=t.text,n=t.disabled,a=w.a.button(y(),n?"#c4cfc1":"#4CAF50",n?"0.6":"1",n?"#c4cfc1":"#5bc146");return r.a.createElement("div",{style:{height:"42px"}},r.a.createElement(a,{onClick:e,disabled:n},i))};function E(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function C(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?E(i,!0).forEach(function(e){Object(h.a)(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):E(i).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}var M=function(t){var e=Object(n.useState)({mixer:1,running:0,completed:0,pid:0}),i=Object(l.a)(e,2),a=i[0],s=i[1],o=Object(n.useRef)(null),h={display:"inline-block",verticalAlign:"top",width:"370px",marginLeft:"5px",marginRight:"5px"},u=function(t){t.preventDefault(),console.log("Restart selected");var e=o.current.simulation.reset(p(0)),i=C({},a,{mixer:e,running:1,completed:0,pid:0});s(i),o.current.simulation.setPid(!1),o.current.simulation.setRunning(!0)},m=function(t){t.preventDefault(),console.log("PID selected");var e=o.current.simulation.reset(p(1)),i=C({},a,{mixer:e,running:1,completed:0,pid:1});s(i),o.current.simulation.setPid(!0),o.current.simulation.setRunning(!0)},p=function(t){return function(e){console.log("COMPLETION CALLBACK",a),o.current.simulation.setRunning(!1);var i=C({},a,{mixer:e,running:0,completed:1,pid:t});s(i)}};Object(n.useEffect)(function(){console.log("start hook"),console.log(t.location.search),c(o.current,f());var e=o.current.simulation.reset(p(a.pid));s(C({},a,{mixer:e}))},[]);return r.a.createElement("div",null,r.a.createElement("div",{style:{paddingLeft:"25px",paddingRight:"25px"}},r.a.createElement("h1",null,"Have a Nice Shower!"),r.a.createElement("p",null,"You are entering a shower. But it's way too cold! Use the shower mixer controls to set the temperature to a reasonable setting."),r.a.createElement("p",null,"You can follow the current temperature from the graph below. The convenient zone is marked with the green lines, so aim to get the temperature between them."),r.a.createElement(k,{text:"Start",onClick:function(t){t.preventDefault(),console.log("Start selected"),o.current.simulation.setRunning(!0),s(C({},a,{running:1}))},disabled:a.running||a.completed})),r.a.createElement("canvas",{style:{marginLeft:"5px",marginRight:"5px",paddingLeft:"25px",paddingRight:"25px",paddingTop:"10px"},ref:o,width:"590",height:"400"}),r.a.createElement("div",{style:{paddingLeft:"25px",width:"590px",paddingRight:"25px"}},r.a.createElement("div",{style:{display:"inline-block",verticalAlign:"top",width:"200px",marginLeft:"5px",marginRight:"5px"}},r.a.createElement("div",null,"Shower Mixer Control"),r.a.createElement(T,{value:a.mixer,min:0,max:1,step:.0025,onChange:function(){return function(t){var e=t.y;a.running&&!a.pid&&function(t){var e=t.mixer,i=C({},a,{mixer:e});console.log("Change shower",i),s(i),o.current.simulation.setMixer(i.mixer)}(C({},a,{mixer:e}))}}})),r.a.createElement(function(t){var e=t.visible;return t.pid?r.a.createElement("div",{style:h},"PID controls",r.a.createElement(k,{text:"Restart PID",onClick:m}),r.a.createElement(k,{text:"Manual Control",onClick:u})):e?r.a.createElement("div",{style:h},r.a.createElement("h2",null,"Well done!"),r.a.createElement("p",null,"This demo explores the behaviour of shower users, when there is a noticeable delay between controlling the mixer (input) and the temperature change (output)."),r.a.createElement("p",null,"The hypothesis is that the feedback loop created by the user and the shower makes the system output first oscillate, and then stabilizes at the convenient temperature. Much like a PI controller with overshooting calibration would control the system."),r.a.createElement(k,{text:"Restart",onClick:u,disabled:!a.completed}),r.a.createElement(k,{text:"Run with PI controller",onClick:m})):r.a.createElement("div",{style:h})},{visible:a.completed,pid:a.pid})))},O=function(t){return Object(n.useEffect)(function(){console.log("app effect")}),r.a.createElement("div",{style:{marginLeft:"auto",marginRight:"auto",maxWidth:"600px"}},r.a.createElement(M,{location:window.location}),r.a.createElement(o,null))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(r.a.createElement(O,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(t){t.unregister()})}},[[21,1,2]]]);
//# sourceMappingURL=main.b6ad5e3f.chunk.js.map