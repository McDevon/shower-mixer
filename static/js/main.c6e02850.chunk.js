(window["webpackJsonpshower-mixer"]=window["webpackJsonpshower-mixer"]||[]).push([[0],{29:function(e,t,i){e.exports=i(42)},34:function(e,t,i){},42:function(e,t,i){"use strict";i.r(t);var n=i(0),a=i.n(n),r=i(16),s=i.n(r),o=(i(34),function(){return a.a.createElement("div",{style:{textAlign:"right"}},a.a.createElement("p",null,"Copyright (c) Jussi Enroos 2019",a.a.createElement("br",null),a.a.createElement("a",{href:"https://github.com/McDevon/shower-mixer"},"Source")," with MIT license"))}),l=i(6),h=i(2),c=i(3),u=i(26),m=i(17),p=i(27),d=function(e,t){if(void 0!==typeof e.getContext){!function(){for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"]}();var i=e.getContext("2d"),n=(new Date).getTime(),a=0,r=0,s=0,o=0;e.simulation=t,t.init(e);!function e(){for(window.requestAnimationFrame(e),a=(new Date).getTime(),r=Math.min((a-n)/1e3,.03),o=0,(s+=r)<1/60&&(s=1/60);s>=1/60&&o<1;)t.fixedUpdate(1/60),s-=1/60,o++;o>=1&&(s=0),t.update(r),t.render(i),n=a}()}},g=function(){function e(t){Object(h.a)(this,e),this.size=t,this.buffer=[],this.buffer.length=t,this.nextIndex=0}return Object(c.a)(e,[{key:"put",value:function(e){this.buffer[this.nextIndex]=e,this.nextIndex=(this.nextIndex+1)%this.size}},{key:"getHead",value:function(){return this.buffer[(this.nextIndex-1)%this.size]}},{key:"getTail",value:function(){return this.buffer[this.nextIndex]}},{key:"getAll",value:function(){for(var e=this.nextIndex,t=[],i=0;i<this.size;i++)t.push(this.buffer[e]),e=(e+1)%this.size;return t}}]),e}(),x=function(){function e(t,i,n,a,r,s){Object(h.a)(this,e),this.margin=5,this.width=a.width-2*this.margin,this.height=a.height-2*this.margin,this.maxVals=t,this.top=i,this.bottom=n,this.targetTop=r,this.targetBottom=s,this.stepLength=(this.width-2*this.margin)/t,this.verticalStep=(this.height-2*this.margin)/(i-n),this.cx=a.getContext("2d")}return Object(c.a)(e,[{key:"drawChartLine",value:function(e,t,i,n,a,r){this.cx.stroke(),1!==r&&(this.cx.fillStyle=0===r?"#BBBBFF55":"#FFBBBB55",this.cx.lineTo(t,e<this.targetBottom?a:n),this.cx.lineTo(i,e<this.targetBottom?a:n),this.cx.fill())}},{key:"draw",value:function(e){var t=this.pixel(this.margin),i=this.pixel(this.margin),n=this.pixel(t+this.width-2*this.margin),a=this.pixel(i+this.height-2*this.margin),r=i+this.height-this.verticalStep*(this.targetTop-this.bottom),s=i+this.height-this.verticalStep*(this.targetBottom-this.bottom);this.cx.strokeStyle="#002200",this.cx.lineWidth=2;var o=t,l=i+this.height-this.verticalStep*(e[0]-this.bottom),h=1;this.cx.beginPath(),this.cx.moveTo(o,l);for(var c=t,u=e[0],m=0,p=e.length;m<p;m++){var d=e[m],g=d<this.targetBottom?0:d>this.targetTop?2:1,x=t+this.stepLength*m,f=i+this.height-this.verticalStep*(d-this.bottom);g!==h&&(this.drawChartLine(u,o,c,r,s,h),this.cx.beginPath(),this.cx.moveTo(o,l),h=g,c=o,u=d),this.cx.lineTo(x,f),o=x,l=f}this.drawChartLine(u,o,c,r,s,h),this.cx.strokeStyle="#000000",this.cx.fillStyle="#000000",this.cx.lineWidth=1,this.cx.beginPath(),this.cx.moveTo(t,i),this.cx.lineTo(t,a),this.cx.stroke(),this.cx.beginPath(),this.cx.moveTo(t,i),this.cx.lineTo(t-2,i+10),this.cx.lineTo(t+2,i+10),this.cx.fill(),this.cx.beginPath(),this.cx.moveTo(t,a),this.cx.lineTo(n,a),this.cx.stroke(),this.cx.beginPath(),this.cx.moveTo(n,a),this.cx.lineTo(n-10,a-2),this.cx.lineTo(n-10,a+2),this.cx.fill(),this.cx.strokeStyle="#77AA77",this.cx.beginPath(),this.cx.moveTo(t,this.pixel(i+this.height-this.verticalStep*(this.targetTop-this.bottom))),this.cx.lineTo(n,this.pixel(i+this.height-this.verticalStep*(this.targetTop-this.bottom))),this.cx.moveTo(t,this.pixel(i+this.height-this.verticalStep*(this.targetBottom-this.bottom))),this.cx.lineTo(n,this.pixel(i+this.height-this.verticalStep*(this.targetBottom-this.bottom))),this.cx.stroke()}},{key:"pixel",value:function(e){return Math.round(e)+.5}}]),e}(),f=function(){function e(t,i,n,a,r){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];Object(h.a)(this,e),this.e=0,this.lastE=0,this.p=t,this.i=i,this.d=n,this.minU=a,this.maxU=r,this.iTerm=0,this.antiWindup=s}return Object(c.a)(e,[{key:"step",value:function(e,t){var i=t-e,n=this.iTerm+i,a=i-this.lastE,r=this.p*i+this.i*n+this.d*a,s=!1;return r>this.maxU?(r=this.maxU,this.antiWindup&&i>0&&(s=!0)):r<this.minU&&(r=this.minU,this.antiWindup&&i<0&&(s=!0)),s||(this.iTerm=n),this.lastE=i,r}}]),e}(),v=function(){function e(){Object(h.a)(this,e)}return Object(c.a)(e,[{key:"init",value:function(e){this.canvas=e,this.width=e.width,this.height=e.height;this.delayQueue=new g(180),this.running=!0,this.targetTemperature=36,this.minTemperature=15,this.maxTemperature=55,this.maxChangeSpeed=4,this.completionTime=4,this.completeTimer=0,this.timer=0,this.maxDeltaSpeed=.02,this.lastDiff=0,this.pidControlValue=0,this.running=!1,this.usePid=!1,this.reset()}},{key:"reset",value:function(e,t){this.controlMinTemperature=this.minTemperature+12*Math.random(),this.controlMaxTemperature=this.maxTemperature-10*Math.random(),this.currentTemperature=this.controlMinTemperature+3*Math.random(),this.mixerTemperature=this.currentTemperature,this.completionCallback=e,this.pidCallback=t,this.timer=0;for(var i=0;i<this.delayQueue.size;i++)this.delayQueue.put(this.currentTemperature);return this.graphList=new g(1800),this.plotter=new x(1800,this.maxTemperature,this.minTemperature,this.canvas,this.targetTemperature+.5,this.targetTemperature-.5),this.pid=new f(.001,15e-5,0,0,1,!0),this.tempToMixer(this.mixerTemperature)}},{key:"setRunning",value:function(e){this.running=e}},{key:"setUsePid",value:function(e){this.usePid=e}},{key:"setPidValues",value:function(e){var t=e.p,i=e.i,n=e.d;this.pid.p=t,this.pid.i=i,this.pid.d=n}},{key:"tempToMixer",value:function(e){return 1-(e-this.controlMinTemperature)/(this.controlMaxTemperature-this.controlMinTemperature)}},{key:"mixerToTemp",value:function(e){return this.controlMinTemperature+(this.controlMaxTemperature-this.controlMinTemperature)*(1-e)}},{key:"completed",value:function(){console.log("COMPLETED!"),this.completionCallback(this.timer)}},{key:"setMixer",value:function(e){this.mixerTemperature=this.mixerToTemp(e),console.log("Target ".concat(this.mixerTemperature))}},{key:"fixedUpdate",value:function(e){if(this.running){this.timer+=e,this.usePid&&(this.pidControlValue=1-this.pid.step(this.delayQueue.getTail()||this.currentTemperature,this.targetTemperature),this.mixerTemperature=this.mixerToTemp(this.pidControlValue));var t=this.mixerTemperature-this.currentTemperature,i=t,n=this.maxChangeSpeed/(this.maxDeltaSpeed*e);if(Math.abs(t)<n){var a=Math.abs(t)*this.maxDeltaSpeed;i=Math.sign(t)*a}Math.abs(i)>this.maxChangeSpeed*e&&(i=this.maxChangeSpeed*Math.sign(i)*e),Math.abs(i)>Math.abs(this.lastDiff)&&Math.abs(this.lastDiff-i)>this.maxDeltaSpeed*e&&(i=this.lastDiff+this.maxDeltaSpeed*e*Math.sign(i)),this.lastDiff=i,this.currentTemperature+=i;var r=this.delayQueue.getTail();this.delayQueue.put(this.currentTemperature),this.graphList.put(r),r<this.targetTemperature+.5&&r>this.targetTemperature-.5?(this.completeTimer+=e,this.completeTimer>=this.completionTime&&this.completed()):this.completeTimer=0}}},{key:"update",value:function(e){this.usePid&&this.pidCallback(this.pidControlValue)}},{key:"render",value:function(e){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.plotter.draw(this.graphList.getAll().filter(function(e){return null!=e}))}}]),e}(),b=function(){return new v},w=i(9),y=function(e){var t=e.value,i=e.step,n=e.min,r=e.max,s=e.onChange;e.suffix;return a.a.createElement("div",{style:{margin:"10px 5px"}},a.a.createElement(w.a,{axis:"y",ystep:i,ymin:n,ymax:r,y:t,onChange:s(),styles:{track:{backgroundColor:"red",height:300},active:{backgroundColor:"blue"}}}))},T=function(e){var t=e.label,i=e.value,n=e.step,r=e.min,s=e.max,o=e.onChange,l=e.suffix,h=void 0===l?"":l,c=e.labelValue,u=void 0===c?i:c;return a.a.createElement("div",{style:{marginTop:"5px",marginLeft:"5px",marginRight:"5px",marginBottom:"5px"}},a.a.createElement("div",null,"".concat(t,": ").concat(u).concat(h)),a.a.createElement(w.a,{axis:"x",xstep:n,xmin:r,xmax:s,x:i,onChange:o()}))};function E(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function k(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?E(i,!0).forEach(function(t){Object(l.a)(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):E(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}var C=function(e){var t=e.pid,i=e.changePid;return a.a.createElement("div",{style:{padding:"10px 0px"}},a.a.createElement(T,{label:"P",value:t.p,labelValue:(t.p/.2).toFixed(3),min:0,max:.2,step:.001,onChange:function(){return function(e){var n=e.x;return i(k({},t,{p:n}))}}}),a.a.createElement(T,{label:"I",value:t.i,labelValue:(t.i/3e-4).toFixed(3),min:0,max:3e-4,step:3e-4/200,onChange:function(){return function(e){var n=e.x;return i(k({},t,{i:n}))}}}),a.a.createElement(T,{label:"D",value:t.d,labelValue:(t.d/5).toFixed(3),min:-5,max:5,step:.05,onChange:function(){return function(e){var n=e.x;return i(k({},t,{d:n}))}}}))},S=i(20),O=i(21);function P(){var e=Object(S.a)(["\n    background-color: ",";\n    border: none;\n    border-radius: 4px;\n    color: white;\n    padding: 10px 20px;\n    text-align: center;\n    text-decoration: none;\n    display: inline-block;\n    margin: 0px;\n    font-size: 16px;\n    opacity: ",";\n    :hover {\n        background-color: ",";\n    }\n    :focus {\n        outline: none;\n    }\n    :active {\n        padding: 9px 18px;\n        font-size: 14px;\n        margin: 1px 4px;\n    }\n    "]);return P=function(){return e},e}var j=function(e){var t=e.onClick,i=e.text,n=e.disabled,r=O.a.button(P(),n?"#c4cfc1":"#4CAF50",n?"0.6":"1",n?"#c4cfc1":"#5bc146");return a.a.createElement("div",{style:{height:"42px",marginRight:"5px"}},a.a.createElement(r,{onClick:t,disabled:n},i))},M=i(4),D=Object(M.a)(function(e){var t=e.visible,i=e.showPid,n=e.completed,r=e.pidSelected,s=e.restartSelected,o=e.pid,l=e.changePid,h={display:"inline-block",verticalAlign:"top",width:"370px",marginLeft:"5px",marginRight:"5px"},c={display:"flex"};return i?a.a.createElement("div",{style:h},"PID controls",a.a.createElement(C,{pid:o,changePid:l}),a.a.createElement("p",null,"By default the controller is set to be a slightly too slow PI controller. Running the system is close to running a step response test for the controller."),a.a.createElement("p",null,"At start, the initial value and control range are randomized."),a.a.createElement("div",{style:c},a.a.createElement(j,{text:"Restart PID",onClick:r}),a.a.createElement(j,{text:"Manual Control",onClick:s}))):t?a.a.createElement("div",{style:h},a.a.createElement("h2",null,"Well done!"),a.a.createElement("p",null,"This demo explores the behaviour of shower users, when there is a noticeable delay between controlling the mixer (input) and the temperature change (output)."),a.a.createElement("p",null,"The hypothesis is that the feedback loop created by the user and the shower typically makes the system output first oscillate, and then stabilize at the convenient temperature range. Much like when a bit too slow PI controller would control the system."),a.a.createElement("div",{style:c},a.a.createElement(j,{text:"Restart",onClick:s,disabled:!n}),a.a.createElement(j,{text:"Run With PI Controller",onClick:r}))):a.a.createElement("div",{style:h})}),R=Object(M.a)(function(e){var t=e.startSelected,i=e.startDisabled;return a.a.createElement("div",{style:{paddingLeft:"25px",paddingRight:"25px"}},a.a.createElement("h1",null,"Have a Nice Shower!"),a.a.createElement("p",null,"You are entering a shower. But it's way too cold! Use the shower mixer controls to set the temperature to a reasonable setting."),a.a.createElement("p",null,"You can follow the current temperature from the graph below. The convenient zone is marked with the green lines, so aim to get the temperature between them."),a.a.createElement(j,{text:"Start",onClick:t,disabled:i}))}),B=Object(M.a)(function(e){var t=e.completed,i=e.time;return t?a.a.createElement("div",null,"\x1cCompleted in ".concat(i.toFixed(2),"s")):a.a.createElement("div",null)});function L(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function A(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?L(i,!0).forEach(function(t){Object(l.a)(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):L(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}var I=function(e){function t(e){var i;return Object(h.a)(this,t),(i=Object(u.a)(this,Object(m.a)(t).call(this,e))).completionCallback=function(e){return function(t){console.log("COMPLETION CALLBACK",t),i.canvasElement.current.simulation.setRunning(!1);var n={running:0,completed:1,pid:e};i.setState({page:n,time:t})}},i.pidCallback=function(e){i.setState({shower:e})},i.startSelected=function(e){e.preventDefault(),console.log("Start selected"),i.canvasElement.current.simulation.setRunning(!0),i.setState({page:A({},i.state.pageState,{running:1})})},i.pidSelected=function(e){e.preventDefault(),console.log("PID selected"),i.setState({shower:i.canvasElement.current.simulation.reset(i.completionCallback(1),i.pidCallback)});i.setState({page:{running:1,completed:0,pid:1}}),i.canvasElement.current.simulation.setPidValues(i.state.pid),i.canvasElement.current.simulation.setUsePid(!0),i.canvasElement.current.simulation.setRunning(!0)},i.restartSelected=function(e){e.preventDefault(),console.log("Restart selected"),i.setState({shower:i.canvasElement.current.simulation.reset(i.completionCallback(0),i.pidCallback)});i.setState({page:{running:1,completed:0,pid:0}}),i.canvasElement.current.simulation.setUsePid(!1),i.canvasElement.current.simulation.setRunning(!0)},i.changePid=function(e){i.setState({pid:e}),i.canvasElement.current.simulation.setPidValues(e)},i.changeShower=function(e){console.log("Change shower",e),i.setState({shower:e}),i.canvasElement.current.simulation.setMixer(e)},i.state={shower:1,time:0,page:{running:0,completed:0,pid:0},pid:{p:.001,i:15e-5,d:0}},i.canvasElement=a.a.createRef(),i}return Object(p.a)(t,e),Object(c.a)(t,[{key:"componentDidMount",value:function(){d(this.canvasElement.current,b());var e=this.canvasElement.current.simulation.reset(this.completionCallback(this.state.page.pid),this.pidCallback);this.canvasElement.current.simulation.setPidValues(this.state.pid),this.canvasElement.current.simulation.setUsePid(this.state.page.pid),this.canvasElement.current.simulation.setRunning(this.state.page.running),this.setState({shower:e})}},{key:"render",value:function(){var e=this;return a.a.createElement("div",null,a.a.createElement(R,{startSelected:this.startSelected,startDisabled:this.state.page.running||this.state.page.completed}),a.a.createElement("canvas",{style:{marginLeft:"5px",marginRight:"5px",paddingLeft:"25px",paddingRight:"25px",paddingTop:"10px"},ref:this.canvasElement,width:"590",height:"400"}),a.a.createElement("div",{style:{paddingLeft:"25px",width:"590px",paddingRight:"25px"}},a.a.createElement("div",{style:{display:"inline-block",verticalAlign:"top",width:"200px",marginLeft:"5px",marginRight:"5px"}},a.a.createElement("div",null,"Shower Mixer Control"),a.a.createElement(y,{value:this.state.shower,min:0,max:1,step:.0025,onChange:function(){return function(t){var i=t.y;e.state.page.running&&!e.state.page.pid&&e.changeShower(i)}}}),a.a.createElement(B,{completed:this.state.page.completed,time:this.state.time})),a.a.createElement(D,{visible:this.state.page.completed,showPid:this.state.page.pid,pidSelected:this.pidSelected,restartSelected:this.restartSelected,pid:this.state.pid,changePid:this.changePid,completed:this.state.page.completed})))}}]),t}(a.a.Component),F=function(e){return Object(n.useEffect)(function(){console.log("app effect")}),a.a.createElement("div",{style:{marginLeft:"auto",marginRight:"auto",maxWidth:"600px"}},a.a.createElement(I,{location:window.location}),a.a.createElement(o,null))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(a.a.createElement(F,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[29,1,2]]]);
//# sourceMappingURL=main.c6e02850.chunk.js.map