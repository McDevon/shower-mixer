(window["webpackJsonpshower-mixer"]=window["webpackJsonpshower-mixer"]||[]).push([[0],{21:function(e,t,i){e.exports=i(32)},26:function(e,t,i){},32:function(e,t,i){"use strict";i.r(t);var n=i(0),r=i.n(n),a=i(13),s=i.n(a),o=(i(26),function(){return r.a.createElement("div",{style:{textAlign:"right"}},r.a.createElement("p",null,"Copyright (c) Jussi Enroos 2019",r.a.createElement("br",null),r.a.createElement("a",{href:"https://github.com/McDevon/shower-mixer"},"Source")," with MIT license"))}),h=i(4),l=i(11),c=function(e,t){if(void 0!==typeof e.getContext){!function(){for(var e=["webkit","moz"],t=0;t<e.length&&!window.requestAnimationFrame;++t)window.requestAnimationFrame=window[e[t]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[t]+"CancelAnimationFrame"]||window[e[t]+"CancelRequestAnimationFrame"]}();var i=e.getContext("2d"),n=(new Date).getTime(),r=0,a=0,s=0,o=0;e.simulation=t,t.init(e);!function e(){for(window.requestAnimationFrame(e),r=(new Date).getTime(),a=Math.min((r-n)/1e3,.03),o=0,(s+=a)<1/60&&(s=1/60);s>=1/60&&o<1;)t.fixedUpdate(1/60),s-=1/60,o++;o>=1&&(s=0),t.update(a),t.render(i),n=r}()}},u=i(2),m=i(3),p=function(){function e(t){Object(u.a)(this,e),this.size=t,this.buffer=[],this.buffer.length=t,this.nextIndex=0}return Object(m.a)(e,[{key:"put",value:function(e){this.buffer[this.nextIndex]=e,this.nextIndex=(this.nextIndex+1)%this.size}},{key:"getHead",value:function(){return this.buffer[(this.nextIndex-1)%this.size]}},{key:"getTail",value:function(){return this.buffer[this.nextIndex]}},{key:"getAll",value:function(){for(var e=this.nextIndex,t=[],i=0;i<this.size;i++)t.push(this.buffer[e]),e=(e+1)%this.size;return t}}]),e}(),d=function(){function e(t,i,n,r,a,s){Object(u.a)(this,e),this.margin=5,this.width=r.width-2*this.margin,this.height=r.height-2*this.margin,this.maxVals=t,this.top=i,this.bottom=n,this.targetTop=a,this.targetBottom=s,this.stepLength=(this.width-2*this.margin)/t,this.verticalStep=(this.height-2*this.margin)/(i-n),this.cx=r.getContext("2d")}return Object(m.a)(e,[{key:"drawChartLine",value:function(e,t,i,n,r,a){this.cx.stroke(),1!==a&&(this.cx.fillStyle=0===a?"#BBBBFF55":"#FFBBBB55",this.cx.lineTo(t,e<this.targetBottom?r:n),this.cx.lineTo(i,e<this.targetBottom?r:n),this.cx.fill())}},{key:"draw",value:function(e){var t=this.pixel(this.margin),i=this.pixel(this.margin),n=this.pixel(t+this.width-2*this.margin),r=this.pixel(i+this.height-2*this.margin),a=i+this.height-this.verticalStep*(this.targetTop-this.bottom),s=i+this.height-this.verticalStep*(this.targetBottom-this.bottom);this.cx.strokeStyle="#002200",this.cx.lineWidth=2;var o=t,h=i+this.height-this.verticalStep*(e[0]-this.bottom),l=1;this.cx.beginPath(),this.cx.moveTo(o,h);for(var c=t,u=e[0],m=0,p=e.length;m<p;m++){var d=e[m],g=d<this.targetBottom?0:d>this.targetTop?2:1,x=t+this.stepLength*m,f=i+this.height-this.verticalStep*(d-this.bottom);g!==l&&(this.drawChartLine(u,o,c,a,s,l),this.cx.beginPath(),this.cx.moveTo(o,h),l=g,c=o,u=d),this.cx.lineTo(x,f),o=x,h=f}this.drawChartLine(u,o,c,a,s,l),this.cx.strokeStyle="#000000",this.cx.fillStyle="#000000",this.cx.lineWidth=1,this.cx.beginPath(),this.cx.moveTo(t,i),this.cx.lineTo(t,r),this.cx.stroke(),this.cx.beginPath(),this.cx.moveTo(t,i),this.cx.lineTo(t-2,i+10),this.cx.lineTo(t+2,i+10),this.cx.fill(),this.cx.beginPath(),this.cx.moveTo(t,r),this.cx.lineTo(n,r),this.cx.stroke(),this.cx.beginPath(),this.cx.moveTo(n,r),this.cx.lineTo(n-10,r-2),this.cx.lineTo(n-10,r+2),this.cx.fill(),this.cx.strokeStyle="#77AA77",this.cx.beginPath(),this.cx.moveTo(t,this.pixel(i+this.height-this.verticalStep*(this.targetTop-this.bottom))),this.cx.lineTo(n,this.pixel(i+this.height-this.verticalStep*(this.targetTop-this.bottom))),this.cx.moveTo(t,this.pixel(i+this.height-this.verticalStep*(this.targetBottom-this.bottom))),this.cx.lineTo(n,this.pixel(i+this.height-this.verticalStep*(this.targetBottom-this.bottom))),this.cx.stroke()}},{key:"pixel",value:function(e){return Math.round(e)+.5}}]),e}(),g=function(){function e(t,i,n,r,a){var s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];Object(u.a)(this,e),this.e=0,this.lastE=0,this.p=t,this.i=i,this.d=n,this.minU=r,this.maxU=a,this.iTerm=0,this.antiWindup=s}return Object(m.a)(e,[{key:"step",value:function(e,t){var i=t-e,n=this.iTerm+i,r=i-this.lastE,a=this.p*i+this.i*n+this.d*r,s=!1;return a>this.maxU?(a=this.maxU,this.antiWindup&&i>0&&(s=!0)):a<this.minU&&(a=this.minU,this.antiWindup&&i<0&&(s=!0)),s||(this.iTerm=n),this.lastE=i,a}}]),e}(),x=function(){function e(){Object(u.a)(this,e)}return Object(m.a)(e,[{key:"init",value:function(e){this.canvas=e,this.width=e.width,this.height=e.height;this.delayQueue=new p(180),this.running=!0,this.targetTemperature=36,this.minTemperature=15,this.maxTemperature=55,this.maxChangeSpeed=4,this.completionTime=4,this.completeTimer=0,this.maxDeltaSpeed=.02,this.lastDiff=0,this.running=!1,this.usePid=!1,this.reset()}},{key:"reset",value:function(e){this.controlMinTemperature=this.minTemperature+12*Math.random(),this.controlMaxTemperature=this.maxTemperature-10*Math.random(),this.currentTemperature=this.controlMinTemperature+3*Math.random(),this.mixerTemperature=this.currentTemperature,this.completionCallback=e;for(var t=0;t<this.delayQueue.size;t++)this.delayQueue.put(this.currentTemperature);return this.graphList=new p(1800),this.plotter=new d(1800,this.maxTemperature,this.minTemperature,this.canvas,this.targetTemperature+.5,this.targetTemperature-.5),this.pid=new g(.001,15e-5,0,0,1,!0),this.tempToMixer(this.mixerTemperature)}},{key:"setRunning",value:function(e){this.running=e}},{key:"setUsePid",value:function(e){this.usePid=e}},{key:"setPidValues",value:function(e){var t=e.p,i=e.i,n=e.d;this.pid.p=t,this.pid.i=i,this.pid.d=n}},{key:"tempToMixer",value:function(e){return 1-(e-this.controlMinTemperature)/(this.controlMaxTemperature-this.controlMinTemperature)}},{key:"mixerToTemp",value:function(e){return this.controlMinTemperature+(this.controlMaxTemperature-this.controlMinTemperature)*(1-e)}},{key:"completed",value:function(){console.log("COMPLETED!"),this.completionCallback(this.tempToMixer(this.mixerTemperature))}},{key:"setMixer",value:function(e){this.mixerTemperature=this.mixerToTemp(e),console.log("Target ".concat(this.mixerTemperature))}},{key:"fixedUpdate",value:function(e){if(this.running){if(this.usePid){var t=1-this.pid.step(this.delayQueue.getTail()||this.currentTemperature,this.targetTemperature);this.mixerTemperature=this.mixerToTemp(t)}var i=this.mixerTemperature-this.currentTemperature,n=i,r=this.maxChangeSpeed/(this.maxDeltaSpeed*e);if(Math.abs(i)<r){var a=Math.abs(i)*this.maxDeltaSpeed;n=Math.sign(i)*a}Math.abs(n)>this.maxChangeSpeed*e&&(n=this.maxChangeSpeed*Math.sign(n)*e),Math.abs(n)>Math.abs(this.lastDiff)&&Math.abs(this.lastDiff-n)>this.maxDeltaSpeed*e&&(n=this.lastDiff+this.maxDeltaSpeed*e*Math.sign(n)),this.lastDiff=n,this.currentTemperature+=n;var s=this.delayQueue.getTail();this.delayQueue.put(this.currentTemperature),this.graphList.put(s),s<this.targetTemperature+.5&&s>this.targetTemperature-.5?(this.completeTimer+=e,this.completeTimer>=this.completionTime&&this.completed()):this.completeTimer=0}}},{key:"update",value:function(e){}},{key:"render",value:function(e){this.canvas.getContext("2d").clearRect(0,0,this.canvas.width,this.canvas.height),this.plotter.draw(this.graphList.getAll().filter(function(e){return null!=e}))}}]),e}(),f=function(){return new x},v=i(7),b=function(e){var t=e.value,i=e.step,n=e.min,a=e.max,s=e.onChange;e.suffix;return console.log("Mixer value ".concat(t)),r.a.createElement("div",{style:{marginTop:"5px",marginLeft:"5px",marginRight:"5px",marginBottom:"5px"}},r.a.createElement(v.a,{axis:"y",ystep:i,ymin:n,ymax:a,y:t,onChange:s(),styles:{track:{backgroundColor:"red",height:300},active:{backgroundColor:"blue"}}}))},T=i(16),w=i(17);function y(){var e=Object(T.a)(["\n    background-color: ",";\n    border: none;\n    border-radius: 4px;\n    color: white;\n    padding: 10px 20px;\n    text-align: center;\n    text-decoration: none;\n    display: inline-block;\n    margin: 0px;\n    font-size: 16px;\n    opacity: ",";\n    :hover {\n        background-color: ",";\n    }\n    :focus {\n        outline: none;\n    }\n    :active {\n        padding: 9px 18px;\n        font-size: 14px;\n        margin: 1px 4px;\n    }\n    "]);return y=function(){return e},e}var k=function(e){var t=e.onClick,i=e.text,n=e.disabled,a=w.a.button(y(),n?"#c4cfc1":"#4CAF50",n?"0.6":"1",n?"#c4cfc1":"#5bc146");return r.a.createElement("div",{style:{height:"42px"}},r.a.createElement(a,{onClick:t,disabled:n},i))},E=function(e){var t=e.label,i=e.value,n=e.step,a=e.min,s=e.max,o=e.onChange,h=e.suffix,l=void 0===h?"":h,c=e.labelValue,u=void 0===c?i:c;return r.a.createElement("div",{style:{marginTop:"5px",marginLeft:"5px",marginRight:"5px",marginBottom:"5px"}},r.a.createElement("div",null,"".concat(t,": ").concat(u).concat(l)),r.a.createElement(v.a,{axis:"x",xstep:n,xmin:a,xmax:s,x:i,onChange:o()}))};function O(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function P(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?O(i,!0).forEach(function(t){Object(h.a)(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):O(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}var C=function(e){var t=e.pid,i=e.changePid;return r.a.createElement("div",{style:{padding:"10px 0px"}},r.a.createElement(E,{label:"P",value:t.p,labelValue:(t.p/1).toFixed(3),min:0,max:1,step:.005,onChange:function(){return function(e){var n=e.x;return i(P({},t,{p:n}))}}}),r.a.createElement(E,{label:"I",value:t.i,labelValue:(t.i/3e-4).toFixed(3),min:0,max:3e-4,step:3e-4/200,onChange:function(){return function(e){var n=e.x;return i(P({},t,{i:n}))}}}),r.a.createElement(E,{label:"D",value:t.d,labelValue:(t.d/5).toFixed(3),min:0,max:5,step:.025,onChange:function(){return function(e){var n=e.x;return i(P({},t,{d:n}))}}}))},S=function(e){var t=e.visible,i=e.showPid,n=e.pidSelected,a=e.restartSelected,s=e.pid,o=e.changePid,h=e.shower,l={display:"inline-block",verticalAlign:"top",width:"370px",marginLeft:"5px",marginRight:"5px"};return i?r.a.createElement("div",{style:l},"PID controls",r.a.createElement(C,{pid:s,changePid:o}),r.a.createElement(k,{text:"Restart PID",onClick:n}),r.a.createElement(k,{text:"Manual Control",onClick:a})):t?r.a.createElement("div",{style:l},r.a.createElement("h2",null,"Well done!"),r.a.createElement("p",null,"This demo explores the behaviour of shower users, when there is a noticeable delay between controlling the mixer (input) and the temperature change (output)."),r.a.createElement("p",null,"The hypothesis is that the feedback loop created by the user and the shower makes the system output first oscillate, and then stabilize at the convenient temperature range. Much like a PI controller with a slightly too high integral term would control the system."),r.a.createElement(k,{text:"Restart",onClick:a,disabled:!h.completed}),r.a.createElement(k,{text:"Run with PI controller",onClick:n})):r.a.createElement("div",{style:l})};function j(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),i.push.apply(i,n)}return i}function M(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?j(i,!0).forEach(function(t){Object(h.a)(e,t,i[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):j(i).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))})}return e}var D=function(e){var t=Object(n.useState)({mixer:1,running:0,completed:0,pid:0}),i=Object(l.a)(t,2),a=i[0],s=i[1],o=Object(n.useState)({p:.001,i:15e-5,d:0}),h=Object(l.a)(o,2),u=h[0],m=h[1],p=Object(n.useRef)(null),d=function(e){return function(t){console.log("COMPLETION CALLBACK",a,e),p.current.simulation.setRunning(!1);var i=M({},a,{mixer:t,running:0,completed:1,pid:e});s(i)}};return Object(n.useEffect)(function(){console.log("start hook"),console.log(e.location.search),c(p.current,f());var t=p.current.simulation.reset(d(a.pid));p.current.simulation.setPidValues(u),p.current.simulation.setUsePid(a.pid),p.current.simulation.setRunning(a.running),s(M({},a,{mixer:t}))},[]),r.a.createElement("div",null,r.a.createElement("div",{style:{paddingLeft:"25px",paddingRight:"25px"}},r.a.createElement("h1",null,"Have a Nice Shower!"),r.a.createElement("p",null,"You are entering a shower. But it's way too cold! Use the shower mixer controls to set the temperature to a reasonable setting."),r.a.createElement("p",null,"You can follow the current temperature from the graph below. The convenient zone is marked with the green lines, so aim to get the temperature between them."),r.a.createElement(k,{text:"Start",onClick:function(e){e.preventDefault(),console.log("Start selected"),p.current.simulation.setRunning(!0),s(M({},a,{running:1}))},disabled:a.running||a.completed})),r.a.createElement("canvas",{style:{marginLeft:"5px",marginRight:"5px",paddingLeft:"25px",paddingRight:"25px",paddingTop:"10px"},ref:p,width:"590",height:"400"}),r.a.createElement("div",{style:{paddingLeft:"25px",width:"590px",paddingRight:"25px"}},r.a.createElement("div",{style:{display:"inline-block",verticalAlign:"top",width:"200px",marginLeft:"5px",marginRight:"5px"}},r.a.createElement("div",null,"Shower Mixer Control"),r.a.createElement(b,{value:a.mixer,min:0,max:1,step:.0025,onChange:function(){return function(e){var t=e.y;a.running&&!a.pid&&function(e){var t=e.mixer,i=M({},a,{mixer:t});console.log("Change shower",i),s(i),p.current.simulation.setMixer(i.mixer)}(M({},a,{mixer:t}))}}})),r.a.createElement(S,{visible:a.completed,showPid:a.pid,pidSelected:function(e){e.preventDefault(),console.log("PID selected");var t=p.current.simulation.reset(d(1)),i=M({},a,{mixer:t,running:1,completed:0,pid:1});s(i),p.current.simulation.setPidValues(u),p.current.simulation.setUsePid(!0),p.current.simulation.setRunning(!0)},restartSelected:function(e){e.preventDefault(),console.log("Restart selected");var t=p.current.simulation.reset(d(0)),i=M({},a,{mixer:t,running:1,completed:0,pid:0});s(i),p.current.simulation.setUsePid(!1),p.current.simulation.setRunning(!0)},pid:u,changePid:function(e){console.log("Set pid",u,e),m(e),p.current.simulation.setPidValues(e)},shower:a})))},R=function(e){return Object(n.useEffect)(function(){console.log("app effect")}),r.a.createElement("div",{style:{marginLeft:"auto",marginRight:"auto",maxWidth:"600px"}},r.a.createElement(D,{location:window.location}),r.a.createElement(o,null))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));s.a.render(r.a.createElement(R,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})}},[[21,1,2]]]);
//# sourceMappingURL=main.7815a519.chunk.js.map